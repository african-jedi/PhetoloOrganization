name: build and Test .Net Applications
permissions:
  contents: read

on:
   push:
     branches: [ main ]

jobs:
   build-test-dotnetapp:
     runs-on: ubuntu-latest

     steps:
        - uses: actions/checkout@v4
   
        - name: Setup dotnet
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: '9.0.x'
       
        - name: Install dependencies
          working-directory: ./Backend
          run: dotnet restore
     
        - name: Build
          working-directory: ./Backend
          run: dotnet build --no-restore
     
        - name: Test with the dotnet CLI
          working-directory: ./Backend
          run: dotnet test --no-build --collect:"XPlat Code Coverage" --results-directory ./TestResults/coverageresults
        
        - name: Install ReportGenerator
          run: dotnet tool install -g dotnet-reportgenerator-globaltool
        
        - name: Generate Coverage Report
          run: reportgenerator -reports:"Backend/TestResults/coverageresults/**/*.xml" -targetdir:"Backend/coverage-report" -reporttypes:"Html"
        
        - name: Check Code Coverage Threshold
          shell: pwsh
          run: |
            $xmlFile = Get-ChildItem -Path "Backend/TestResults/coverageresults" -Filter "*.xml" -Recurse | Select-Object -First 1
            [xml]$coverageXml = Get-Content $xmlFile.FullName
            $lineCoverage = [decimal]$coverageXml.CoverageSession.Summary.linecoverage
            Write-Host "Line Coverage: $lineCoverage%"
            if ($lineCoverage -lt 80) {
              Write-Host "Error: Code coverage is below 80% threshold"
              exit 1
            }